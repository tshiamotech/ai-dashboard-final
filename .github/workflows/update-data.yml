name: Daily AI Update

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Fetch real market data
        env:
          API_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        run: |
          RESPONSE=$(curl -s "https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=SPY&apikey=$API_KEY")

          PRICE=$(echo $RESPONSE | jq -r '.["Global Quote"]["05. price"]')
          CHANGE=$(echo $RESPONSE | jq -r '.["Global Quote"]["10. change percent"]')

          CONFIDENCE=50
          RECOMMENDATION="HOLD"

          CHANGE_NUM=$(echo $CHANGE | tr -d '%')

          if (( $(echo "$CHANGE_NUM > 0.5" | bc -l) )); then
            RECOMMENDATION="BUY / LONG"
            CONFIDENCE=72
          fi

          echo "{
            \"price\": \"$PRICE\",
            \"change\": \"$CHANGE\",
            \"recommendation\": \"$RECOMMENDATION\",
            \"confidence\": $CONFIDENCE,
            \"lastUpdated\": \"$(date -u)\"
          }" > data/market.json

      - name: Commit updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/market.json
          git commit -m "Daily real market update" || echo "No changes"
          git push
